/*ANO PHOTOTOOL UPLOAD AND CROPPING IMAGES*/
(function(e){e.fn.anoUpload=function(t){var n="anoUpload";var r={refreshTime:1e3},i=this.data(n);if(i){i.target.remove();clearTimeout(i.timer);r=i.settings}else{i={};i.settings=r;i.actionUrl=this.attr("action");this.data(n,i)}i.uploading=false;if(t){e.extend(r,t)}var s=this;var o=this.attr("name")+"iframe";i.target=e("<iframe>").css({position:"absolute",top:"-1000px",width:"1px",height:"1px"}).attr("name",o);var u=function(){e.ajax({type:"GET",url:r.actionUrl+r.id,dataType:"json",success:a,error:f})};var a=function(e){if(!e)return;if(typeof r.onStatus=="function"){r.onStatus(e)}if(e.status>0){i.timer=setTimeout(u,r.refreshTime)}else{i.uploading=false}};var f=function(e){if(typeof r.onError=="function"){r.onError(e)}};var l=function(t){e.extend(r,t);i.uploading=true;i.timer=setTimeout(u,1);s.attr({action:r.actionUrl+r.id,target:i.target.attr("name")}).after(i.target).find("input:file").attr("name","file");s.submit()};r.actionUrl=i.actionUrl;e.ajax({type:"GET",url:r.actionUrl,dataType:"json",success:l,error:f})}})(jQuery);(function(e){function s(){return e("<div/>")}var t=Math.abs,n=Math.max,r=Math.min,i=Math.round;e.imgAreaSelect=function(o,u){function Q(e){return e+y.left-S.left}function G(e){return e+y.top-S.top}function Y(e){return e-y.left+S.left}function Z(e){return e-y.top+S.top}function et(e){return e.pageX-S.left}function tt(e){return e.pageY-S.top}function nt(e){var t=e||k,n=e||L;return{x1:i(q.x1*t),y1:i(q.y1*n),x2:i(q.x2*t),y2:i(q.y2*n),width:i(q.x2*t)-i(q.x1*t),height:i(q.y2*n)-i(q.y1*n)}}function rt(e,t,n,r,s){var o=s||k,u=s||L;q={x1:i(e/o||0),y1:i(t/u||0),x2:i(n/o||0),y2:i(r/u||0)};q.width=q.x2-q.x1;q.height=q.y2-q.y1}function it(){if(!a.width())return;y={left:i(a.offset().left),top:i(a.offset().top)};b=a.innerWidth();w=a.innerHeight();y.top+=a.outerHeight()-w>>1;y.left+=a.outerWidth()-b>>1;O=i(u.minWidth/k)||0;M=i(u.minHeight/L)||0;_=i(r(u.maxWidth/k||1<<24,b));D=i(r(u.maxHeight/L||1<<24,w));if(e().jquery=="1.3.2"&&T=="fixed"&&!R["getBoundingClientRect"]){y.top+=n(document.body.scrollTop,R.scrollTop);y.left+=n(document.body.scrollLeft,R.scrollLeft)}S=/absolute|relative/.test(E.css("position"))?{left:i(E.offset().left)-E.scrollLeft(),top:i(E.offset().top)-E.scrollTop()}:T=="fixed"?{left:e(document).scrollLeft(),top:e(document).scrollTop()}:{left:0,top:0};m=Q(0);g=G(0);if(q.x2>b||q.y2>w)ht()}function st(t){if(!H)return;l.css({left:Q(q.x1),top:G(q.y1)}).add(c).width(V=q.width).height(J=q.height);c.add(h).add(d).css({left:0,top:0});h.width(n(V-h.outerWidth()+h.innerWidth(),0)).height(n(J-h.outerHeight()+h.innerHeight(),0));e(p[0]).css({left:m,top:g,width:q.x1,height:w});e(p[1]).css({left:m+q.x1,top:g,width:V,height:q.y1});e(p[2]).css({left:m+q.x2,top:g,width:b-q.x2,height:w});e(p[3]).css({left:m+q.x1,top:g+q.y2,width:V,height:w-q.y2});V-=d.outerWidth();J-=d.outerHeight();switch(d.length){case 8:e(d[4]).css({left:V>>1});e(d[5]).css({left:V,top:J>>1});e(d[6]).css({left:V>>1,top:J});e(d[7]).css({top:J>>1});case 4:d.slice(1,3).css({left:V});d.slice(2,4).css({top:J})}if(t!==false){if(e.imgAreaSelect.keyPress!=Et)e(document).unbind(e.imgAreaSelect.keyPress,e.imgAreaSelect.onKeyPress);if(u.keys)e(document)[e.imgAreaSelect.keyPress](e.imgAreaSelect.onKeyPress=Et)}if(e.browser.msie&&h.outerWidth()-h.innerWidth()==2){h.css("margin",0);setTimeout(function(){h.css("margin","auto")},0)}}function ot(e){it();st(e);B=Q(q.x1);j=G(q.y1);F=Q(q.x2);I=G(q.y2)}function ut(e,t){u.fadeSpeed?e.fadeOut(u.fadeSpeed,t):e.hide()}function at(e){var t=Y(et(e))-q.x1,n=Z(tt(e))-q.y1;if(!K){it();K=true;l.one("mouseout",function(){K=false})}A="";if(u.resizable){if(n<=u.resizeMargin)A="n";else if(n>=q.height-u.resizeMargin)A="s";if(t<=u.resizeMargin)A+="w";else if(t>=q.width-u.resizeMargin)A+="e"}l.css("cursor",A?A+"-resize":u.movable?"move":"");if(v)v.toggle()}function ft(t){e("body").css("cursor","");if(u.autoHide||q.width*q.height==0)ut(l.add(p),function(){e(this).hide()});e(document).unbind("mousemove",pt);l.mousemove(at);u.onSelectEnd(o,nt())}function lt(t){if(t.which!=1)return false;it();if(A){e("body").css("cursor",A+"-resize");B=Q(q[/w/.test(A)?"x2":"x1"]);j=G(q[/n/.test(A)?"y2":"y1"]);e(document).mousemove(pt).one("mouseup",ft);l.unbind("mousemove",at)}else if(u.movable){N=m+q.x1-et(t);C=g+q.y1-tt(t);l.unbind("mousemove",at);e(document).mousemove(vt).one("mouseup",function(){u.onSelectEnd(o,nt());e(document).unbind("mousemove",vt);l.mousemove(at)})}else a.mousedown(t);return false}function ct(e){if(P)if(e){F=n(m,r(m+b,B+t(I-j)*P*(F>B||-1)));I=i(n(g,r(g+w,j+t(F-B)/P*(I>j||-1))));F=i(F)}else{I=n(g,r(g+w,j+t(F-B)/P*(I>j||-1)));F=i(n(m,r(m+b,B+t(I-j)*P*(F>B||-1))));I=i(I)}}function ht(){B=r(B,m+b);j=r(j,g+w);if(t(F-B)<O){F=B-O*(F<B||-1);if(F<m)B=m+O;else if(F>m+b)B=m+b-O}if(t(I-j)<M){I=j-M*(I<j||-1);if(I<g)j=g+M;else if(I>g+w)j=g+w-M}F=n(m,r(F,m+b));I=n(g,r(I,g+w));ct(t(F-B)<t(I-j)*P);if(t(F-B)>_){F=B-_*(F<B||-1);ct()}if(t(I-j)>D){I=j-D*(I<j||-1);ct(true)}q={x1:Y(r(B,F)),x2:Y(n(B,F)),y1:Z(r(j,I)),y2:Z(n(j,I)),width:t(F-B),height:t(I-j)};st();u.onSelectChange(o,nt())}function pt(e){F=/w|e|^$/.test(A)||P?et(e):Q(q.x2);I=/n|s|^$/.test(A)||P?tt(e):G(q.y2);ht();return false}function dt(t,n){F=(B=t)+q.width;I=(j=n)+q.height;e.extend(q,{x1:Y(B),y1:Z(j),x2:Y(F),y2:Z(I)});st();u.onSelectChange(o,nt())}function vt(e){B=n(m,r(N+et(e),m+b-q.width));j=n(g,r(C+tt(e),g+w-q.height));dt(B,j);e.preventDefault();return false}function mt(){e(document).unbind("mousemove",mt);it();F=B;I=j;ht();A="";if(!p.is(":visible"))l.add(p).hide().fadeIn(u.fadeSpeed||0);H=true;e(document).unbind("mouseup",gt).mousemove(pt).one("mouseup",ft);l.unbind("mousemove",at);u.onSelectStart(o,nt())}function gt(){e(document).unbind("mousemove",mt).unbind("mouseup",gt);ut(l.add(p));rt(Y(B),Z(j),Y(B),Z(j));if(!this instanceof e.imgAreaSelect){u.onSelectChange(o,nt());u.onSelectEnd(o,nt())}}function yt(t){if(t.which!=1||p.is(":animated"))return false;it();N=B=et(t);C=j=tt(t);e(document).mousemove(mt).mouseup(gt);return false}function bt(){ot(false)}function wt(){f=true;xt(u=e.extend({classPrefix:"imgareaselect",movable:true,parent:"body",resizable:true,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},u));l.add(p).css({visibility:""});if(u.show){H=true;it();st();l.add(p).hide().fadeIn(u.fadeSpeed||0)}setTimeout(function(){u.onInit(o,nt())},0)}function St(e,t){for(option in t)if(u[option]!==undefined)e.css(t[option],u[option])}function xt(t){if(t.parent)(E=e(t.parent)).append(l.add(p));e.extend(u,t);it();if(t.handles!=null){d.remove();d=e([]);W=t.handles?t.handles=="corners"?4:8:0;while(W--)d=d.add(s());d.addClass(u.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:x+2||2});if(!parseInt(d.css("width"))>=0)d.width(5).height(5);if(X=u.borderWidth)d.css({borderWidth:X,borderStyle:"solid"});St(d,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}k=u.imageWidth/b||1;L=u.imageHeight/w||1;if(t.x1!=null){rt(t.x1,t.y1,t.x2,t.y2);t.show=!t.hide}if(t.keys)u.keys=e.extend({shift:1,ctrl:"resize"},t.keys);p.addClass(u.classPrefix+"-outer");c.addClass(u.classPrefix+"-selection");for(W=0;W++<4;)e(h[W-1]).addClass(u.classPrefix+"-border"+W);St(c,{selectionColor:"background-color",selectionOpacity:"opacity"});St(h,{borderOpacity:"opacity",borderWidth:"border-width"});St(p,{outerColor:"background-color",outerOpacity:"opacity"});if(X=u.borderColor1)e(h[0]).css({borderStyle:"solid",borderColor:X});if(X=u.borderColor2)e(h[1]).css({borderStyle:"dashed",borderColor:X});l.append(c.add(h).add(v).add(d));if(e.browser.msie){if(X=p.css("filter").match(/opacity=(\d+)/))p.css("opacity",X[1]/100);if(X=h.css("filter").match(/opacity=(\d+)/))h.css("opacity",X[1]/100)}if(t.hide)ut(l.add(p));else if(t.show&&f){H=true;l.add(p).fadeIn(u.fadeSpeed||0);ot()}P=(z=(u.aspectRatio||"").split(/:/))[0]/z[1];a.add(p).unbind("mousedown",yt);if(u.disable||u.enable===false){l.unbind("mousemove",at).unbind("mousedown",lt);e(window).unbind("resize",bt)}else{if(u.enable||u.disable===false){if(u.resizable||u.movable)l.mousemove(at).mousedown(lt);e(window).resize(bt)}if(!u.persistent)a.add(p).mousedown(yt)}u.enable=u.disable=undefined}var a=e(o),f,l=s(),c=s(),h=s().add(s()).add(s()).add(s()),p=s().add(s()).add(s()).add(s()),d=e([]),v,m,g,y={left:0,top:0},b,w,E,S={left:0,top:0},x=0,T="absolute",N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q={x1:0,y1:0,x2:0,y2:0,width:0,height:0},R=document.documentElement,U,z,W,X,V,J,K;var Et=function(e){var t=u.keys,i,s,o=e.keyCode;i=!isNaN(t.alt)&&(e.altKey||e.originalEvent.altKey)?t.alt:!isNaN(t.ctrl)&&e.ctrlKey?t.ctrl:!isNaN(t.shift)&&e.shiftKey?t.shift:!isNaN(t.arrows)?t.arrows:10;if(t.arrows=="resize"||t.shift=="resize"&&e.shiftKey||t.ctrl=="resize"&&e.ctrlKey||t.alt=="resize"&&(e.altKey||e.originalEvent.altKey)){switch(o){case 37:i=-i;case 39:s=n(B,F);B=r(B,F);F=n(s+i,B);ct();break;case 38:i=-i;case 40:s=n(j,I);j=r(j,I);I=n(s+i,j);ct(true);break;default:return}ht()}else{B=r(B,F);j=r(j,I);switch(o){case 37:dt(n(B-i,m),j);break;case 38:dt(B,n(j-i,g));break;case 39:dt(B+r(i,b-Y(F)),j);break;case 40:dt(B,j+r(i,w-Z(I)));break;default:return}}return false};this.remove=function(){xt({disable:true});l.add(p).remove()};this.getOptions=function(){return u};this.setOptions=xt;this.getSelection=nt;this.setSelection=rt;this.cancelSelection=gt;this.update=ot;U=a;while(U.length){x=n(x,!isNaN(U.css("z-index"))?U.css("z-index"):x);if(U.css("position")=="fixed")T="fixed";U=U.parent(":not(body)")}x=u.zIndex||x;if(e.browser.msie)a.attr("unselectable","on");e.imgAreaSelect.keyPress=e.browser.msie||e.browser.safari?"keydown":"keypress";if(e.browser.opera)v=s().css({width:"100%",height:"100%",position:"absolute",zIndex:x+4||4});l.add(p).css({visibility:"hidden",position:T,overflow:"hidden",zIndex:x+2||2});l.css({zIndex:x+4||4});c.add(h).css({position:"absolute",fontSize:0});o.complete||o.readyState=="complete"||!a.is("img")?wt():a.one("load",wt);if(e.browser.msie&&e.browser.version>=7)o.src=o.src};e.fn.imgAreaSelect=function(t){t=t||{};this.each(function(){if(e(this).data("imgAreaSelect")){if(t.remove){e(this).data("imgAreaSelect").remove();e(this).removeData("imgAreaSelect")}else e(this).data("imgAreaSelect").setOptions(t)}else if(!t.remove){if(t.enable===undefined&&t.disable===undefined)t.enable=true;e(this).data("imgAreaSelect",new e.imgAreaSelect(this,t))}});if(t.instance)return e(this).data("imgAreaSelect");return this}})(jQuery);$(function(){function r(n){n.rotation=t;e.push(n)}function i(){if(e.length<2){return}e.pop();var i=e.pop(),s=false;t=i.rotation;$(".ano_phototool_photo").attr("src","photos/workbench?id="+n+"&r="+i.rotation);ias.setSelection(i.x1,i.y1,i.x2,i.y2);ias.setOptions({show:true});ias.update();var o=ias.getSelection();var a=document.getElementsByClassName("ano_phototool_photo");u(a,o,s);r(i)}function s(){var e=$('form[name="workbenchPictureForm"]');$.ajax({type:"POST",url:e.attr("action"),data:e.serialize(),success:function(e){if(e){if(e.status=="OK"){var t=$(".image_selected"),n=300;imgSrc="photos/d/"+e.encodedPhotoId+"/"+n+"/?preview=true",imgId=e.encodedPhotoId;$("form span.mt_x span").text("");$(".ano_phototool_workbench").hide();$(".uploadPicture").hide();$("#photoUploadedDecisionButtons").hide();t.children("input.imageId").val(imgId);if(t.children("img").length>0){t.children("img").attr("src",imgSrc)}else{t.append("<img src=' "+imgSrc+" '/>")}$(".imageAddBlock").children("img").imgScaleCut("fixImages",false)}else alert(e.error)}}});if(typeof ias!="undefined"){ias.cancelSelection()}$(".ano_phototool_preview").children("img").remove()}function o(){$("form span.mt_x span").text("");$(".ano_phototool_workbench").hide();$(".uploadPicture").hide();$("#photoUploadedDecisionButtons").hide();if(typeof ias!="undefined"){ias.cancelSelection()}$(".ano_phototool_preview").children("img").remove()}function u(e,i,s,o){if(!i.width||!i.height)return;var u=100/i.width;var a=100/i.height;$(".ano_phototool_photo").attr("src","photos/workbench?id="+n+"&r="+t);if(typeof o!="undefined"){$(".ano_phototool_photo").load(function(){ias.setOptions({show:true});ias.update()})}$(".ano_phototool_preview img").attr("src",$(e).attr("src"));$(".ano_phototool_preview img").css({width:Math.round(u*$(e).width()),height:Math.round(a*$(e).height()),marginLeft:-Math.round(u*i.x1),marginTop:-Math.round(a*i.y1)});if(s!=false){r(i)}var f="{"+'"x":'+Math.floor(i.x1)+","+'"y":'+Math.floor(i.y1)+","+'"w":'+Math.floor(i.width)+","+'"h":'+Math.floor(i.height)+","+'"r":'+t+"}";$("input[name=transition]").val(f)}var e=[];var t=0;var n;$(".ano_phototool_rotateright").click(function(){t=(t+1)%4;var e=ias.getSelection();var n=document.getElementsByClassName("ano_phototool_photo");u(n,e,true,true)});$(".ano_phototool_rotateleft").click(function(){t=(t+3)%4;var e=ias.getSelection();var n=document.getElementsByClassName("ano_phototool_photo");u(n,e,true,true)});$(".ano_phototool_undo").click(i);$("input:file").click(function(){$(this).one("change",function(){$(this).blur()})});$("form[name=uploadPicture]").bind("change",function(){if(typeof ias!="undefined"){ias.cancelSelection()}$(".validationWizard").hide();$("div#photoUploadedDecisionButtons").hide();$("div.ano_phototool_preview").fadeOut();$("div.ano_phototool_selector").fadeOut(function(){$("div.ano_phototool_workbench").slideUp()});$(".cabinet").fadeTo(.5);var r=$(".progressbar");r.show();$(this).anoUpload({onStatus:function(i){var s="";if(i.status>0){s=i.progress+"%";r.css("background-position",(i.progress-100)*r.width()/100+"px")}if(i.status==0){s=i.filename+" "+i.size;r.hide();$.ajax({type:"GET",url:"photos/workbench?uploadid="+i.id,dataType:"json",success:function(r){$(".ano_phototool_photo").load(function(){$(this).unbind("load");$("div.ano_phototool_workbench").slideDown(function(){ias=$(".ano_phototool_photo").imgAreaSelect({x1:10,y1:10,x2:100,y2:100,handles:true,onInit:u,onSelectChange:u,instance:true,keys:true})});$("div.ano_phototool_preview").fadeIn();$(this).focus()});var i=$("div#ano_phototool_bottom_anchor");if(i){try{$("html, body").animate({scrollTop:i.offset().top},1e3)}catch(s){}}var o=$("div#photoUploadedDecisionButtons");if(o)try{o.show()}catch(s){}$("input[name=wbid]").val(r.id);e=[];t=0;n=r.id;$(".ano_phototool_photo").attr("src","photos/workbench?id="+n+"&r="+t);if($(".ano_phototool_preview").children("img").length>0){$(".ano_phototool_preview").children("img").attr("src","photos/workbench?id="+n+"&r="+t)}else{$(".ano_phototool_preview").append('<img src="photos/workbench?id='+n+"&r="+t+'"/>')}},error:function(e){alert(e)}})}if(i.status<0){if($("#link_photo_block").is(":visible")){$(".validationWizard").find(".image").remove();var o={forcedHorizontal:"",offsetTop:0,offsetLeft:33};var a=new Notification(o);a.show($('input[name="pLink"]'),"No large images could be found. Please check your link again and make sure that it points to one picture - not a whole website - and try again",true)}else{s="Error! ("+i.status+")"}}$("form span.mt_x span").text(s)}})});$(".imageAddBlock").live("click",function(){$(".image_selected").removeClass("image_selected");var e=$(this);e.addClass("image_selected");$(".uploadPicture").show();return false});$("#save_photo").click(function(){s();return false});$("#cancel_photo").click(function(){o();return false});$(".imageAddBlock").children("img",this).imagesLoaded(function(){$(".imageAddBlock").children("img").imgScaleCut("fixImages",false)});$(".uploadPicture").hide()})
